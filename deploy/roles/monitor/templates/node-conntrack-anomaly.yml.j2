groups:
- name: node-conntrack-anomaly
  rules:
    - alert: NodeConntrackSynAnomaly
      # Unified expression, automatically grouped by direction
      expr: sum by (direction, source_ip, target_ip, instance, hostname, tcp_state) (conntrack_unreplied_syn_flows) > {{ threshold | default(150) }}
      for: {{ duration | default("2m") }}
      labels:
        # Dynamically reference labels generated by the script
        severity: {{ severity | default("warning") }}
        component: network
        # alert_type can also be dynamically generated based on direction
        alert_type: "node-syn-{{ $labels.direction }}"
        direction: "{{ $labels.direction }}"
        source_ip: "{{ $labels.source_ip }}"
        target_ip: "{{ $labels.target_ip }}"
        tcp_state: "{{ $labels.tcp_state }}"
        hostname: "{{ $labels.hostname }}"
      annotations:
        summary: "High unreplied SYN connections ({{ $labels.direction }}): {{ $labels.source_ip }} -> {{ $labels.target_ip }}"
        description: |
          Direction: {{ $labels.direction }}
          Source IP: {{ $labels.source_ip }}
          Target IP: {{ $labels.target_ip }}
          Total unreplied SYN connections: {{ $value }}
          Instance: {{ $labels.instance }}
          Hostname: {{ $labels.hostname }}
          TCP State: {{ $labels.tcp_state }}
          Action Required:
          - If inbound: Check if Target IP in {{ $labels.hostname }} is under SYN Flood attack.
          - If outbound: Check if Source IP in {{ $labels.hostname }} (VM) is compromised or scanning.
          Query: conntrack_unreplied_syn_flows{direction="{{ $labels.direction }}",source_ip="{{ $labels.source_ip }}",target_ip="{{ $labels.target_ip }}"}
