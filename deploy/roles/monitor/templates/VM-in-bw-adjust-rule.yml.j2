groups:
- name: vm_in_bw_adjustment_{{ rule_group }}
  interval: 15s
  rules:
  # Get total inbound bandwidth configuration from custom metrics (Mbps)
  - record: vm_in_bw_total_mbps_{{ rule_group }}
    expr: |
      sum by (domain, target_device) (vm_interface_bandwidth_config_mbps{direction="in"})
      * on(domain, target_device) group_right()
      max by (domain, target_device, rule_id, instance_id) (
        up{job="vm-group-metadata", rule_id=~"adjust-bw-.*-{{ rule_group_original }}"} == 1
      )

  # Raw inbound bandwidth speed (per interface, unit: kB/s)
  - record: vm_in_bw_speed_raw_{{ rule_group }}
    expr: |
      sum by (domain, target_device) (rate(libvirt_domain_interface_stats_receive_bytes_total[1m])) / 1024

  # Smoothed inbound bandwidth speed (5-minute moving average, unit: kB/s)
  - record: vm_in_bw_speed_{{ rule_group }}
    expr: |
      avg_over_time(vm_in_bw_speed_raw_{{ rule_group }}[{{ smooth_window }}m:1m])

  # Inbound bandwidth speed for VM interfaces associated with the rule group
  - record: vm_in_bw_speed_by_rule_{{ rule_group }}
    expr: |
      vm_in_bw_speed_{{ rule_group }} * on(domain, target_device) group_right()
      max by (domain, target_device, rule_id, instance_id) (
        up{job="vm-group-metadata", rule_id=~"adjust-bw-.*-{{ rule_group_original }}"} == 1
      )

  # Calculate inbound bandwidth usage percentage
  - record: vm_in_bw_usage_percent_{{ rule_group }}
    expr: |
      (
        (vm_in_bw_speed_by_rule_{{ rule_group }} / 1024 * 8)
        /
        vm_in_bw_total_mbps_{{ rule_group }}
        * 100
      )
      and on(domain, target_device)
      (vm_in_bw_total_mbps_{{ rule_group }} > 0)

  # VM interfaces that require inbound bandwidth limit (only when status is normal)
  # The value is the total inbound bandwidth in Mbps for use in webhook
  - record: vm_requires_in_bw_limit_{{ rule_group }}
    expr: |
      (
        (vm_in_bw_usage_percent_{{ rule_group }} > {{ in_high_threshold_pct }})
        and on(domain, rule_id, target_device)
        (
          (vm_bandwidth_adjustment_status{rule_id=~"adjust-bw-.*-{{ rule_group_original }}", type="in"} == 0) or
          (max by (domain, target_device, rule_id, instance_id) (up{job="vm-group-metadata", rule_id=~"adjust-bw-.*-{{ rule_group_original }}"} == 1) unless vm_bandwidth_adjustment_status{rule_id=~"adjust-bw-.*-{{ rule_group_original }}", type="in"})
        )
      )
      * on(domain, target_device) group_left()
      vm_in_bw_total_mbps_{{ rule_group }}

  # Calculate elapsed time since inbound bandwidth limit started (in seconds)
  - record: vm_bandwidth_in_limit_elapsed_seconds_{{ rule_group }}
    expr: |
      (
        (time() - vm_bandwidth_limit_start_timestamp{rule_id=~"adjust-bw-.*-{{ rule_group_original }}", type="in"} / 1000)
        * on(domain, rule_id, target_device)
        (vm_bandwidth_adjustment_status{rule_id=~"adjust-bw-.*-{{ rule_group_original }}", type="in"} == 1)
      )
      * on(domain, rule_id, target_device) group_left(instance_id)
      max by (domain, rule_id, target_device, instance_id) (
        up{job="vm-group-metadata", rule_id=~"adjust-bw-.*-{{ rule_group_original }}"} == 1
      )
