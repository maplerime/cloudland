- name: Install Docker SDK for Python
  become: true
  pip:
    name: docker
    executable: pip3
  tags: [monitor]

- name: Check if Docker is running
  become: true
  command: docker info
  register: docker_status
  ignore_errors: true
  changed_when: false
  tags: [monitor]

- name: Install Docker if not present
  become: true
  apt:
    name: docker.io
    state: present
  when: docker_status.rc != 0
  tags: [monitor]

- name: Start Docker service if not running
  become: true
  systemd:
    name: docker
    state: started
    enabled: yes
  when: docker_status.rc != 0
  tags: [monitor]

- name: Run libvirt-exporter in Docker
  become: true
  docker_container:
    name: prometheus-libvirt-exporter
    image: "kiennt26/prometheus-libvirt-exporter:latest"
    network_mode: host
    volumes:
      - "/:/host:ro,rslave"
      - "/var/run/libvirt:/var/run/libvirt"
    privileged: yes
    restart_policy: always
  tags: [monitor]

- name: Create directory for monitor scripts
  file:
    path: /opt/cloudland/scripts/monitor
    state: directory
    owner: root
    group: root
    mode: '0755'
  tags: [monitor]

- name: Set node exporter port variable
  set_fact:
    node_exporter_port: 9101
  tags: [monitor]

- name: Install prometheus-node-exporter without starting
  become: true
  apt:
    name: prometheus-node-exporter
    state: present
  register: pkg_install
  ignore_errors: true
  tags: [monitor]

- name: Force stop node exporter after install
  become: true
  systemd:
    name: prometheus-node-exporter
    state: stopped
  ignore_errors: true
  changed_when: false
  when: pkg_install is succeeded
  tags: [monitor]

- name: Ensure systemd override directory exists
  file:
    path: /etc/systemd/system/prometheus-node-exporter.service.d
    state: directory
    owner: root
    group: root
    mode: '0755'
  tags: [monitor]

- name: Configure Node Exporter with textfile directory
  become: true
  copy:
    dest: /etc/systemd/system/prometheus-node-exporter.service.d/override.conf
    content: |
      [Service]
      ExecStart=
      ExecStart=/usr/bin/prometheus-node-exporter --web.listen-address=:{{ node_exporter_port }} --collector.textfile.directory=/var/lib/node_exporter
    mode: '0644'
    owner: root
    group: root
  tags: [monitor]

- name: Apply systemd configuration changes
  become: true
  systemd:
    daemon_reload: yes
    name: prometheus-node-exporter
  changed_when: false
  tags: [monitor]

- name: Ensure service started with new config is enabled and started
  become: true
  systemd:
    name: prometheus-node-exporter
    enabled: yes
    state: restarted
    daemon_reload: no
  register: service_status
  until: service_status.status.ActiveState == "active"
  retries: 3
  delay: 5
  tags: [monitor]

- name: Create node_exporter data directory
  file:
    path: /var/lib/node_exporter
    state: directory
    owner: prometheus
    group: prometheus
    mode: '0755'
  tags: [monitor]

- name: Set conntrack collection interval variable
  set_fact:
    conntrack_collection_interval: "{{ conntrack_collection_interval | default('2') }}"
  tags: [monitor]

- name: Install conntrack tools
  become: true
  apt:
    name: conntrack
    state: present
  tags: [monitor]

- name: Check if conntrack-collection systemd units exist
  become: true
  command: systemctl list-units --all --no-pager --no-legend {{ item }}
  register: systemd_unit_check
  failed_when: false
  changed_when: false
  with_items:
    - conntrack-collection.timer
    - conntrack-collection.service
  tags: [monitor]

- name: Stop and disable existing conntrack-collection systemd units
  become: true
  systemd:
    name: "{{ item.item }}"
    state: stopped
    enabled: no
  when: item.rc == 0 and item.stdout | length > 0
  with_items: "{{ systemd_unit_check.results }}"
  tags: [monitor]

- name: Check if conntrack-collection systemd unit files exist
  become: true
  stat:
    path: "{{ item }}"
  register: systemd_file_check
  with_items:
    - /etc/systemd/system/conntrack-collection.service
    - /etc/systemd/system/conntrack-collection.timer
  tags: [monitor]

- name: Remove conntrack-collection systemd unit files
  become: true
  file:
    path: "{{ item.item }}"
    state: absent
  when: item.stat.exists
  with_items: "{{ systemd_file_check.results }}"
  tags: [monitor]

- name: Check if conntrack_unreplied_syn.sh script exists
  become: true
  stat:
    path: /opt/cloudland/scripts/monitor/conntrack_unreplied_syn.sh
  register: script_check
  tags: [monitor]

- name: Remove conntrack_unreplied_syn.sh script
  become: true
  file:
    path: /opt/cloudland/scripts/monitor/conntrack_unreplied_syn.sh
    state: absent
  when: script_check.stat.exists
  tags: [monitor]

- name: Reload systemd daemon after cleanup
  become: true
  systemd:
    daemon_reload: yes
  tags: [monitor]

- name: Deploy systemd service for IP block exporter
  become: true
  template:
    src: ip-block-exporter.service.j2
    dest: /etc/systemd/system/ip-block-exporter.service
    mode: '0644'
  tags: [monitor]

- name: Deploy systemd timer for IP block exporter
  become: true
  template:
    src: ip-block-exporter.timer.j2
    dest: /etc/systemd/system/ip-block-exporter.timer
    mode: '0644'
  tags: [monitor]

- name: Reload systemd for IP block exporter
  become: true
  systemd:
    daemon_reload: yes
  tags: [monitor]

- name: Enable and start ip-block-exporter.timer
  become: true
  systemd:
    name: ip-block-exporter.timer
    enabled: yes
    state: started
  tags: [monitor]

- name: Deploy systemd service for packet drop exporter
  become: true
  template:
    src: packet-drop-exporter.service.j2
    dest: /etc/systemd/system/packet-drop-exporter.service
    mode: '0644'
  tags: [monitor]

- name: Deploy systemd timer for packet drop exporter
  become: true
  template:
    src: packet-drop-exporter.timer.j2
    dest: /etc/systemd/system/packet-drop-exporter.timer
    mode: '0644'
  tags: [monitor]

- name: Reload systemd for packet drop exporter
  become: true
  systemd:
    daemon_reload: yes
  tags: [monitor]

- name: Enable and start packet-drop-exporter.timer
  become: true
  systemd:
    name: packet-drop-exporter.timer
    enabled: yes
    state: started
  tags: [monitor]
